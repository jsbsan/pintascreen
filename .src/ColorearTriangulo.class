' Gambas class file

'convert test.svg test.png
Private imagenExistente As Image
Private Valorcolor As Integer

Public Function lee(valor As Integer) As Image

  If Not IsNull(imagenExistente) And Valorcolor = valor Then
    Return imagenExistente
  Else
    Return coloreaTriangulo(valor)

  Endif

End

Private Function coloreaTriangulo(valor As Integer) As Image

  Dim contenido As String
  Dim i As Image

  ' If Not IsNull(imagenExistente) Then
  '   Return imagenExistente
  ' Endif

  If Exist("/tmp/tri" & Hex(valor) & ".png") Then
    i = Image.Load("/tmp/tri" & Hex(valor) & ".png")
    imagenExistente = i
    Valorcolor = valor
    Return i
  Else

    'lo tengo que crear

    Try Kill "/tmp/triangulo.svg"
    Try Copy "triangulo.svg" To "/tmp/triangulo.svg"
    contenido = File.Load("/tmp/triangulo.svg")

    contenido = Replace(contenido, "fill:#ff0000;", "fill:#" & Hex(valor) & ";")

    File.Save("/tmp/trianguloColoreado.svg", contenido)
    Try Kill "/tmp/tri.png"
    Shell "convert /tmp/trianguloColoreado.svg /tmp/tri" & Hex(valor) & ".png" Wait

    If Exist("/tmp/tri" & Hex(valor) & ".png") Then
      i = Image.Load("/tmp/tri" & Hex(valor) & ".png")
      imagenExistente = i
      Valorcolor = valor
      Return i
      ' Else
      '   comando = "inkscape -z -e /tmp/trianguloColoreado.svg " & "/tmp/tri" & Hex(valor) & ".png"
      '   Shell comando Wait
    Endif

    If Exist("/tmp/tri" & Hex(valor) & ".png") Then
      i = Image.Load("/tmp/tri" & Hex(valor) & ".png")
      imagenExistente = i
      Valorcolor = valor
      Return i
    Else

      'ha habido un problema al crear el triangulo de color determinado, pongo el triangulo por defecto
      i = Image.Load("/tmp/triangulo.png")
      imagenExistente = i
      Valorcolor = valor
      'asignar imagen si hay problemas al crear el triangulo de color
    Endif

    Return i
  Endif

End
